---
title: 浏览器缓存
tags: 
  - HTTP
  - Summary
modify_date: 2022-05-17
---

## 浏览器缓存控制

### HTTP 1.1风格

服务器在返回资源到浏览器时，通过在HTTP响应头增加`Cache-Control`属性控制浏览器缓存

<!--more-->

![image-20220608142659449](https://oliver-blog.oss-cn-shenzhen.aliyuncs.com/202206081427402.png)

例子

`Cache-Control: max-age=31536000` 开启浏览器缓存，缓存有效时间`max-age`，单位为秒。在缓存有效期间，不需要发送网络请求到服务器获取资源，而是直接取浏览器本地资源。缓存过期后，要通过服务器认证，确认缓存还是最新版本，才允许浏览器使用。如缓存并不是最新版本，则服务器返回完整资源。

`Cache-Control: no-store` 不开启浏览器缓存

`Cache-Control: no-cache` 开启浏览缓存，但每次都要先通过服务器认证，确认缓存还是最新版本，才允许浏览器使用。如缓存并不是最新版本，则服务器返回完整资源

`Cache-Control: public` 资源可以被任何对象缓存，包括代理服务器等

`Cache-Control: private` 资源只可以被单个用户缓存，一般是指本地浏览器缓存

`Cache-Control: must-revalidate` 当资源需要服务器认证是否为最新版本时，假如连接不上服务器，则不能使用过期缓存。 反过来，不开启`must-revalidate` 则会使用过期缓存

### HTTP 1.0 风格

服务器在返回资源到浏览器时，通过在HTTP响应头增加`Expires`属性开启浏览器缓存。相当于HTTP 1.1风格的`max-age`

如果在`Cache-Control`响应头设置了 `max-age` 或者 `s-max-age` 指令，那么 `Expires` 头会被忽略

例子

`Expires: Wed, 21 Oct 2015 07:28:00 GMT`

### 隐式开启

服务器在返回资源到浏览器时，通过在HTTP响应头增加`Last-Modified`属性开启浏览器缓存。根据HTTP规范算法，缓存时间为`Date`响应头的时间减去`Last-Modified`的时间，得出的时长再除以10

假如已通过前两种方式开启浏览器缓存，这种方式将被忽略



## 服务器认证缓存是否为最新版本

在浏览器缓存过期，或开启了`no-cache`的情况下，浏览器不会直接使用缓存，而是先向服务器发送请求，以确认缓存是否为最新版本。在这次请求中，服务器将会带上`If-None-Match`或`If-Modified-Since`，属性的值分别对应获取当前浏览器缓存内容的那次响应的`ETag`值和`Last-Modified`值。同时存在的情况下，`If-None-Match`的优先级高于`If-Modified-Since`。

### ETag

服务器端开启`ETag`后，第一次请求资源，会通过某种算法计算`ETag`，然后将`ETag`放到响应头里面。浏览器将会缓存此`ETag`，如果浏览器再次请求同一资源，会把`ETag`的值放到请求头的`If-None-Match`属性里面。服务器接收第二次请求后，把将要返回的内容再次计算`ETag`，然后与请求头的`If-None-Match`的值比对。如果前后两次请求需要返回的内容有变化，则`ETag`的值也不同，服务器会返回完整的响应，响应状态码为200。否则，服务器返回不完整的响应，响应状态码为304

### Last-Modified

与`ETag`类似，只是不需要计算一个`ETag`，而直接取用资源的修改时间来代替。`Last-Modified`的优点是免去了计算`ETag`的消耗，缺点是修改时间一般只能精确到秒，还有`Last-Modified`值不同有可能资源内容却相同



## 通过Chrome的Network查看是否使用缓存

| Status | Size                |                                                              |
| ------ | ------------------- | ------------------------------------------------------------ |
| 200    | (from memory cache) | 直接使用浏览器缓存，且缓存在内存中                           |
| 200    | (from disk cache)   | 直接使用浏览器缓存，且缓存在磁盘中                           |
| 304    | 报文大小            | 通过服务器认证，缓存为最新版本后，浏览器使用缓存             |
| 200    | 报文大小            | 没有使用浏览器缓存，或缓存不是最新版本，从服务器获取最新资源 |

